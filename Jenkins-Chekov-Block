pipeline {
  agent any

  environment {
    AWS_REGION     = 'us-east-1'
    ECR_REGISTRY   = '122610499688.dkr.ecr.us-east-1.amazonaws.com'
    ECR_REPOSITORY = 'tasky'
    IMAGE_TAG      = 'latest'
  }

  stages {

    stage('Checkout Code') {
      steps {
        // same repo Jenkins was pulling in the logs
        git url: 'https://github.com/CSYREPO/CSYTASKY.git', branch: 'main'
      }
    }

    stage('IaC Scan (Checkov - block on ANY severity)') {
      steps {
        script {
          sh '''
            set -e
            mkdir -p checkov-report

            # 1) Human-readable scan (doesn't fail the build directly)
            docker run --rm -v $PWD:/workspace bridgecrew/checkov:latest \
              --directory /workspace/infra/terraform \
              --output cli \
              --soft-fail \
              | tee checkov-report/checkov-report-full.txt

            # 2) JSON scan we will gate on
            docker run --rm -v $PWD:/workspace bridgecrew/checkov:latest \
              --directory /workspace/infra/terraform \
              --output json \
              --soft-fail \
              > checkov-report/checkov-report.json

            # 3) Gate script: fail on LOW, MEDIUM, HIGH, CRITICAL
            cat > checkov-report/checkov-gate.py << 'PYCODE'
import json, sys, pathlib

report_path = pathlib.Path("/data/checkov-report.json")
if not report_path.exists():
    print("checkov-report.json not found, failing gate.")
    sys.exit(1)

data = json.load(report_path.open())

failed_checks = data.get("results", {}).get("failed_checks", [])

# we want to block on anything that has a known severity
block_levels = {"LOW", "MEDIUM", "HIGH", "CRITICAL"}

blocked = []
for item in failed_checks:
    sev = (item.get("severity") or item.get("check_severity") or "").upper()
    if sev in block_levels:
        blocked.append(item)

if blocked:
    print("Blocking build: findings detected (LOW/MEDIUM/HIGH/CRITICAL):")
    for item in blocked:
        cid  = item.get("check_id")
        res  = item.get("resource")
        sev  = (item.get("severity") or item.get("check_severity") or "UNKNOWN").upper()
        print(f" - {cid} [{sev}] in {res}")
    sys.exit(1)

print("No LOW/MEDIUM/HIGH/CRITICAL findings, continuing.")
PYCODE

            # 4) Run the gate inside python container; this is what can fail the stage
            docker run --rm -v $PWD/checkov-report:/data python:3.11-slim \
              python /data/checkov-gate.py
          '''
        }
        archiveArtifacts artifacts: 'checkov-report/*', fingerprint: true
      }
    }

    stage('Build Docker image') {
      steps {
        script {
          sh '''
            docker build -t tasky:latest .
            docker tag tasky:latest ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}
          '''
        }
      }
    }

    stage('Login to ECR & Push') {
      steps {
        script {
          sh '''
            aws ecr get-login-password --region ${AWS_REGION} \
              | docker login --username AWS --password-stdin ${ECR_REGISTRY}

            docker push ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}
          '''
        }
      }
    }

    stage('Deploy to EKS') {
      steps {
        script {
          sh '''
            aws eks update-kubeconfig --region ${AWS_REGION} --name tasky-wiz-eks

            # apply your manifests
            kubectl apply -f k8s/tasky.yaml

            # quick visibility like in the logs
            kubectl get pods -n tasky
            kubectl get svc -n tasky
          '''
        }
      }
    }
  }
}

