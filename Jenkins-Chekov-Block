pipeline {
  agent any

  environment {
    AWS_REGION     = 'us-east-1'
    ECR_REGISTRY   = '122610499688.dkr.ecr.us-east-1.amazonaws.com'
    ECR_REPOSITORY = 'tasky'
    IMAGE_TAG      = 'latest'
  }

  stages {
    stage('Checkout Code') {
      steps {
        git url: 'https://github.com/CSYREPO/CSYTASKY.git', branch: 'main'
      }
    }

    stage('IaC Scan (Checkov - fail on ANY)') {
      steps {
        script {
          sh '''
            set -e
            mkdir -p checkov-report

            # human-readable
            docker run --rm -v $PWD:/workspace bridgecrew/checkov:latest \
              --directory /workspace/infra/terraform \
              --output cli \
              --soft-fail \
              | tee checkov-report/checkov-report-full.txt

            # JSON for gating
            docker run --rm -v $PWD:/workspace bridgecrew/checkov:latest \
              --directory /workspace/infra/terraform \
              --output json \
              --soft-fail \
              > checkov-report/checkov-report.json

            # gate: fail if ANY failed_checks
            cat > checkov-report/checkov-gate.py << 'PYCODE'
import json, sys, pathlib

rp = pathlib.Path("/data/checkov-report.json")
if not rp.exists():
    print("checkov-report.json not found, failing.")
    sys.exit(1)

data = json.load(rp.open())
failed = data.get("results", {}).get("failed_checks", [])

if failed:
    print(f"Blocking build: {len(failed)} failed check(s) found:")
    for item in failed:
        cid = item.get("check_id")
        res = item.get("resource")
        sev = (item.get("severity") or item.get("check_severity") or "UNKNOWN").upper()
        print(f" - {cid} [{sev}] in {res}")
    sys.exit(1)

print("No failed checks, continuing.")
PYCODE

            docker run --rm -v $PWD/checkov-report:/data python:3.11-slim \
              python /data/checkov-gate.py
          '''
        }
        archiveArtifacts artifacts: 'checkov-report/*', fingerprint: true
      }
    }

    stage('Build Docker image') {
      steps {
        sh '''
          docker build -t tasky:latest .
          docker tag tasky:latest ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}
        '''
      }
    }

    stage('Login to ECR & Push') {
      steps {
        sh '''
          aws ecr get-login-password --region ${AWS_REGION} \
            | docker login --username AWS --password-stdin ${ECR_REGISTRY}
          docker push ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}
        '''
      }
    }

    stage('Deploy to EKS') {
      steps {
        sh '''
          aws eks update-kubeconfig --region ${AWS_REGION} --name tasky-wiz-eks
          kubectl apply -f k8s/tasky.yaml
          kubectl get pods -n tasky
          kubectl get svc -n tasky
        '''
      }
    }
  }
}

