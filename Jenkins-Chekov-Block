pipeline {
  agent any

  environment {
    AWS_REGION     = 'us-east-1'
    ECR_REGISTRY   = '122610499688.dkr.ecr.us-east-1.amazonaws.com'
    ECR_REPOSITORY = 'tasky'
    IMAGE_TAG      = 'latest'
  }

  stages {

    stage('Checkout Code') {
      steps {
        // same repo Jenkins was pulling in the logs
        git url: 'https://github.com/CSYREPO/CSYTASKY.git', branch: 'main'
      }
    }

    stage('IaC Scan (Checkov - block on HIGH/CRITICAL)') {
      steps {
        script {
          sh '''
            set -e
            mkdir -p checkov-report

            # 1) Human-readable scan (doesn't fail the build)
            docker run --rm -v $PWD:/workspace bridgecrew/checkov:latest \
              --directory /workspace/infra/terraform \
              --output cli \
              --soft-fail \
              | tee checkov-report/checkov-report-full.txt

            # 2) JSON scan we will gate on
            docker run --rm -v $PWD:/workspace bridgecrew/checkov:latest \
              --directory /workspace/infra/terraform \
              --output json \
              --soft-fail \
              > checkov-report/checkov-report.json

            # 3) Write a tiny gate script to disk
            cat > checkov-report/checkov-gate.py << 'PYCODE'
import json, sys, pathlib

report_path = pathlib.Path("/data/checkov-report.json")
if not report_path.exists():
    print("checkov-report.json not found, failing gate.")
    sys.exit(1)

data = json.load(report_path.open())

failed = []
for item in data.get("results", {}).get("failed_checks", []):
    sev = item.get("severity") or item.get("check_severity")
    if sev and sev.upper() in ("HIGH", "CRITICAL"):
        failed.append((item.get("check_id"), sev, item.get("resource")))

if failed:
    print("Blocking build: HIGH/CRITICAL findings detected:")
    for cid, sev, res in failed:
        print(f" - {cid} [{sev}] in {res}")
    sys.exit(1)

print("No HIGH/CRITICAL findings, continuing.")
PYCODE

            # 4) Run the gate inside python container; this is what can fail the stage
            docker run --rm -v $PWD/checkov-report:/data python:3.11-slim \
              python /data/checkov-gate.py
          '''
        }
        archiveArtifacts artifacts: 'checkov-report/*', fingerprint: true
      }
    }

    stage('Build Docker image') {
      steps {
        script {
          sh '''
            docker build -t tasky:latest .
            docker tag tasky:latest ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}
          '''
        }
      }
    }

    stage('Login to ECR & Push') {
      steps {
        script {
          sh '''
            aws ecr get-login-password --region ${AWS_REGION} \
              | docker login --username AWS --password-stdin ${ECR_REGISTRY}

            docker push ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}
          '''
        }
      }
    }

    stage('Deploy to EKS') {
      steps {
        script {
          sh '''
            aws eks update-kubeconfig --region ${AWS_REGION} --name tasky-wiz-eks

            # apply your manifests
            kubectl apply -f k8s/tasky.yaml

            # quick visibility like in the logs
            kubectl get pods -n tasky
            kubectl get svc -n tasky
          '''
        }
      }
    }
  }
}

