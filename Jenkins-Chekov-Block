pipeline {
  agent any

  environment {
    AWS_REGION    = "us-east-1"
    ECR_REGISTRY  = "122610499688.dkr.ecr.us-east-1.amazonaws.com"
    ECR_REPO      = "tasky"
    IMAGE_TAG     = "latest"
    EKS_CLUSTER   = "tasky-wiz-eks"
  }

  stages {
    stage('Checkout Code') {
      steps {
        git branch: 'main', url: 'https://github.com/CSYREPO/CSYTASKY.git'
      }
    }

    stage('IaC Scan (Checkov - block on HIGH/CRITICAL)') {
      steps {
        script {
          sh '''
            set -e
            mkdir -p checkov-report

            # 1) run checkov once, normal CLI, so you still see it
            docker run --rm -v $PWD:/workspace bridgecrew/checkov:latest \
              --directory /workspace/infra/terraform \
              --output cli \
              --soft-fail \
            | tee checkov-report/checkov-report-full.txt

            # 2) run again to JSON so we can inspect severities
            docker run --rm -v $PWD:/workspace bridgecrew/checkov:latest \
              --directory /workspace/infra/terraform \
              --output json \
              --soft-fail \
              > checkov-report/checkov-report.json

            # 3) parse JSON and fail if any result has severity HIGH or CRITICAL
            #    we use a tiny python container so we don't care what's on the agent
            docker run --rm -v $PWD/checkov-report:/data python:3.11-slim \
              python - << 'PYCODE'
import json, sys, pathlib

data = json.load(open("/data/checkov-report.json"))
failed = []

# checkov json structure has "results": {"failed_checks": [...]}
for item in data.get("results", {}).get("failed_checks", []):
    sev = item.get("severity") or item.get("check_severity")
    if sev and sev.upper() in ("HIGH", "CRITICAL"):
        failed.append((item.get("check_id"), sev, item.get("resource")))

if failed:
    print("Blocking: HIGH/CRITICAL findings detected:")
    for cid, sev, res in failed:
        print(f" - {cid} [{sev}] in {res}")
    sys.exit(1)

print("No HIGH/CRITICAL findings, continuing.")
PYCODE
          '''
        }
        archiveArtifacts artifacts: 'checkov-report/*', fingerprint: true
      }
    }

    stage('Build Docker image') {
      steps {
        sh '''
          docker build -t $ECR_REPO:$IMAGE_TAG .
          docker tag $ECR_REPO:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPO:$IMAGE_TAG
        '''
      }
    }

    stage('Login to ECR & Push') {
      steps {
        sh '''
          aws ecr get-login-password --region $AWS_REGION | \
            docker login --username AWS --password-stdin $ECR_REGISTRY

          docker push $ECR_REGISTRY/$ECR_REPO:$IMAGE_TAG
        '''
      }
    }

    stage('Deploy to EKS') {
      steps {
        sh '''
          aws eks update-kubeconfig --region $AWS_REGION --name $EKS_CLUSTER
          kubectl apply -f k8s/tasky.yaml
          kubectl get pods -n tasky
          kubectl get svc -n tasky
        '''
      }
    }
  }
}

