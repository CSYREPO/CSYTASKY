pipeline {
  agent any

  environment {
    AWS_REGION    = "us-east-1"
    ECR_REGISTRY  = "122610499688.dkr.ecr.us-east-1.amazonaws.com"
    ECR_REPO      = "tasky"
    IMAGE_TAG     = "latest"
    EKS_CLUSTER   = "tasky-wiz-eks"
  }

  stages {
    stage('Checkout') {
      steps {
        // change this if your actual repo is CSYTASKY, but leaving as-is for now
        git branch: 'main', url: 'https://github.com/CSYREPO/tasky.git'
      }
    }

    stage('Build Docker image') {
      steps {
        sh '''
        docker build -t $ECR_REPO:$IMAGE_TAG .
        docker tag $ECR_REPO:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPO:$IMAGE_TAG
        '''
      }
    }

    stage('Login to ECR & Push') {
      steps {
        sh '''
        aws ecr get-login-password --region $AWS_REGION | \
          docker login --username AWS --password-stdin $ECR_REGISTRY

        docker push $ECR_REGISTRY/$ECR_REPO:$IMAGE_TAG
        '''
      }
    }

    stage('Deploy to EKS') {
      steps {
        sh '''
        # configure kube access on this Jenkins EC2
        aws eks update-kubeconfig --region $AWS_REGION --name $EKS_CLUSTER

        # apply the single manifest you have
        kubectl apply -f k8s/tasky.yaml

        # show what got deployed
        kubectl get pods -n tasky
        kubectl get svc -n tasky
        '''
      }
    }
  }
}

